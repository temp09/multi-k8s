Manual RPM Upgrade
The RPM upgrade bundles Xray and all its dependencies. It is provided as native RPM packages, where Xray and its dependencies must be installed separately. Use this, if you are automating installations.
*****************************************************************



https://www.jfrog.com/confluence/display/JFROG/System+Requirements

http://artifacts.sandbox.west.com
led35660
---------
cat /opt/jfrog/xray/scripts/setenv.sh
#!/bin/bash
# Common env for all scripts
#
#     DO NOT EDIT THIS FILE -- YOUR CHANGES WILL BE OVERWRITTEN
#

export XRAY_HOME="/opt/jfrog/xray"
export XRAY_DATA="/var/opt/jfrog/xray/data"
export XRAYCONFIGPATH=${XRAY_DATA}
export POSTGRES_HOME="/var/opt/jfrog/postgres"
export XRAY_USER=xray
export XRAY_GROUP=xrayexport XRAYDIST=redhat
export XRAYDIST=redhat
-----------------------------------------------------led35660
 cat /var/opt/jfrog/xray/data/config/xray_config.yaml
---
    ver:                   1.0
    XrayServerPort:       8000
    mqBaseUrl:            amqp://ea2242$aes256$-wG4nsdvDvj81rICLuFYX_jgXXzrZuQ0Ak9zhQWrMTkoyOXMug88@rabbitmq:5672
    mongoUrl:             mongodb://ea2242$aes256$6IwzNmp7ECJujOB-PIf66Mzuv9aA2xnNeYBZ905MbBaBF0O7u817Cq0=@mongodb:27017/?authSource=xray&authMechanism=SCRAM-SHA-1
    postgresqlUrl:        postgres://ea2242$aes256$hpvSu7MUrXfBPGjs9oyNlPnoAbeEtguEas92dOohrk-WwDrHAWh6ObM=@led36720.wic.west.com:5432/xraydb_02?sslmode=disable
    ForceScan:            true

----------------------------------------------------------led35683
cat /var/opt/jfrog/xray/data/config/xray_config.yaml
---
    ver:                   1.0
    XrayServerPort:       8000
    mqBaseUrl:            amqp://21efa4$aes256$UXNZbEyl1A4mXmXLuOxskMloizEgAcyPXlxbO5uDwrIYaKNh94hi@rabbitmq:5672
    mongoUrl:             mongodb://21efa4$aes256$TTDEfdfsDvsQzRKlDsV_t7rBHjIpSW3o12Rest0HC1qzFtvA30Mfkao=@mongodb:27017/?authSource=xray&authMechanism=SCRAM-SHA-1
    postgresqlUrl:        postgres://21efa4$aes256$xGzmDpD_v1GIhGMgIHEWyf07bVeS7GFLBX3M_AU08Hu3PmGjusX9Akk=@led36722.wic.west.com:5432/xraydb_01?sslmode=disable
    ForceScan:            true
-------------------------------------------------------led01565
sudo cat /var/opt/jfrog/xray/data/config/xray_config.yaml
[sudo] password for aullah:
---
    ver:                   1.0
    XrayServerPort:       8000
    mqBaseUrl:            amqp://1b1adf$aes256$rs5iTfmg-JBfyDU0Hg886MK-CJTwzJXaN-2GU3bS4gsw0tNLNTiW@rabbitmq:5672
    mongoUrl:             mongodb://1b1adf$aes256$CdaMykcnm7uLevpsTqTbvzURU7EgjoKMLIM8e0v6_Qz9xAHV1c9CEMU=@mongodb:27017/?authSource=xray&authMechanism=SCRAM-SHA-1
    postgresqlUrl:        postgres://1b1adf$aes256$vRGTkznq422WHzWSps3tXghQhcM5YmsSPHI4HqXvN6GNx5CLNwA9O9U=@led01734.wic.west.com:5432/xraydb_03?sslmode=disable
    ForceScan:            true
	
New installed/upgrade
----------------------	
shared:
    database:
        type: postgresql
        driver: org.postgresql.Driver
        url: jdbc:postgresql://10.138.0.1:5432/artifactory
        username: artifactory
        password: <redacted>

Compared to Xray:

shared:
    database:
        type: postgresql
        driver: org.postgresql.Driver
        url: postgres://10.138.0.1:5432/xray
        username: xray
        password: <redacted>

1. Download Xray (RPM).                  ?????
sudo wget https://releases.jfrog.io/artifactory/jfrog-xray/xray-rpm/3.17.4/jfrog-xray-3.17.4-rpm.tar.gz

sudo wget https://releases.jfrog.io/artifactory/jfrog-xray/xray-linux/3.17.4/jfrog-xray-3.17.4-linux.tar.gz

2. Stop the current service.

cd /opt/jfrog/xray/scripts
./xray.sh stop

3. Extract the contents of the compressed archive and go to the extracted folder.

sudo tar -xvf jfrog-xray-3.17.4-rpm.tar.gz
cd jfrog-xray-3.17.4-rpm


4. Make sure your MongoDB is running, to ensure that the migration process to PostgreSQL will work.

   ps -eflwww|grep mongo
   
4a. Run sudo ./install.sh
   
5. Install Xray as a service on Red Hat compatible Linux distributions, as a root user.   ?????  ( no need )

   sudo yum -y install ./xray/xray.rpm
   
6. Check that the migration has completed successfully, by reviewing the following files:

    migration log: $JFROG_HOME/xray/var/log/migration.log file

    system.yaml configuration: $JFROG_HOME/xray/var/etc/system.yaml
	
 **** This newly created file will contain your current custom configurations in the new format.

7. Please ensure that a large file handle limit is specified before you start Xray. 

8. Set the Artifactory connection details.    ??????
Xray requires a working Artifactory server and a suitable license. The Xray connection to Artifactory requires 2 parameters:
jfrogUrl - URL to the machine where JFrog Artifactory is deployed, or the load balancer pointing to it. It is recommended to use DNS names rather than direct IPs. For example: "http://jfrog.acme.com or http://10.20.30.40:8082". Note that /artifactory context is not longer required.
Set it in the Shared Configurations section of the $JFROG_HOME/xray/var/etc/system.yaml file.
join.key - This is the "secret" key required by Artifactory for registering and authenticating the Xray server.
You can fetch the Artifactory joinKey (join Key) from the JPD UI in the Administration module | Security | Settings | Join Key. 
Set the join.key used by your Artifactory server in the Shared Configurations section of the $JFROG_HOME/xray/var/etc/system.yaml file.

9. Make sure the third party services are running.

A. PostgreSQL

If you had the PostgreSQL database that was packaged as part of 2.x installed, the same will be used in the current installation. It can be managed using the following commands:

service postgresql-9.5 start|stop|status

B. RabbitMQ

From version 3.x, RabbitMQ is packaged and managed as part of the Xray RPM. Any action (stop, start and status) on the main service of Xray will be performed on RabbitMQ as well. The existing RabbitMQ RPM which was installed as part of 2.x can be uninstalled after Xray 3.x is successfully installed and running.

C. Migrating data from MongoDB to PostgreSQL

From version 3.x, Xray will not use MongoDB except during the migration phase. Make sure both the databases are up and running before Xray services are started. During the migration, Xray will not be accessible. You can uninstall MongoDB after Xray 3.x is successfully installed and running.

service mongod start|stop|status

10.Start Xray.

	systemd OS
	systemctl start xray.service
	systemv OS
	systemctl start xray
	Access Xray from your browser at: http://<jfrogUrl>/ui/, go the Security & Compliance tab in the Application module in the UI.

11. Check Xray Log.

tail -f $JFROG_HOME/xray/var/log/console.log


12. Post Data Migration Steps (MongoDB to PostgreSQL)

After the migration is successfully ended, it is recommended to complete the following steps:

Validate that your Xray data has migrated successfully.
Remove MongoDB configuration from the system.yaml.
Uninstall the MongoDB database.








*********************************



shared:
  jfrogUrl: "https://artifacts.sandbox.west.com/artifactory"
  security:
    joinKey: "ffd9192c1bd074a5419fe2aecfd20909"
