What to backup in apigee:
*************************

In an on-premises deployment of Apigee Edge, we must backup the following Edge components:

1. Apache ZooKeeper (apigee-zookeeper)
2. Apache Cassandra (apigee-cassandra)
3. Postgres Server (edge-postgres-server)
4. PostgreSQL database (apigee-postgresql)
   **** In a Postgres Master/Standby configuration, we only backup the Master. we do not have to backup the slave.****
5. Qpid Server (edge-qpid-server)
6. Qpidd (apigee-qpidd)
7. OpenLDAP (apigee-openldap)
8. Management Server (edge-management-server)
9. Message Processor (edge-message-processor)
10. Router (edge-router)
11. Edge UI (edge-ui)

Before back up some notes:
--------------------------
f you have multiple Cassandra nodes, back them up one at a time.
If you have multiple ZooKeeper nodes, back them up one at a time. The backup process temporarily shuts down ZooKeeper.
If you have multiple Postgres nodes, back them up one at a time.

When you restore one of ZooKeeper, Cassandra or LDAP nodes it is recommended to restore all three nodes in order to achieve consistency (especially when organizations/environments have been created since backup was created).
Note: The above does not affect restoration of one Cassandra or ZooKeeper node in a datastore cluster, since no backup is used.
If LDAP or global administrator passwords are lost/corrupted, a complete backup is required in order to get the same credentials for the last backup and running system.


The backup commands:
---------------------

1. Stops the component (except for PostgreSQL and Cassandra which must be running to backup).

   /opt/apigee/apigee-service/bin/apigee-service edge-message-processor stop
   /opt/apigee/apigee-service/bin/apigee-service edge-router stop
   /opt/apigee/apigee-service/bin/apigee-service edge-ui stop
   /opt/apigee/apigee-service/bin/apigee-service edge-management-server stop
   /opt/apigee/apigee-service/bin/apigee-service apigee-openldap stop
   /opt/apigee/apigee-service/bin/apigee-service apigee-qpidd stop
   /opt/apigee/apigee-service/bin/apigee-service edge-qpid-server stop   
   /opt/apigee/apigee-service/bin/apigee-service apigee-zookeeper stop
   
   apigee-service: apigee-lb: Not running
   
   devportal:
   ----------
   
   /opt/apigee/apigee-service/bin/apigee-service apigee-drupal-devportal stop
    /opt/apigee/apigee-service/bin/apigee-service apigee-drupal-contrib stop
	 /opt/apigee/apigee-service/bin/apigee-service apigee-drupal stop
	  /opt/apigee/apigee-service/bin/apigee-service apigee-drush stop
	  /opt/apigee/apigee-service/bin/apigee-service apigee-php stop
	  /opt/apigee/apigee-service/bin/apigee-service apigee-lb stop
   
   
   
2. Backup specified components:
-------------------------------

   /opt/apigee/apigee-service/bin/apigee-service edge-message-processor backup
   /opt/apigee/apigee-service/bin/apigee-service edge-router backup
   /opt/apigee/apigee-service/bin/apigee-service edge-ui backup
   /opt/apigee/apigee-service/bin/apigee-service edge-management-server backup
   /opt/apigee/apigee-service/bin/apigee-service apigee-openldap backup
   /opt/apigee/apigee-service/bin/apigee-service apigee-qpidd backup
   /opt/apigee/apigee-service/bin/apigee-service edge-qpid-server backup   
   /opt/apigee/apigee-service/bin/apigee-service apigee-zookeeper backup
   /opt/apigee/apigee-service/bin/apigee-service apigee-cassandra backup
   
The backup utility writes the generated backup file to /opt/apigee/backup/comp where comp is the name of the component.
Because you can generate many backup files, and because these files can get large, you can mount a separate disk at /opt/apigee/backup just for backup files.

3. All backup files, except for PostreSQL, are named in the form:
    backup-(year).(month).(day),(hour).(min).(seconds).tar.gz
	
4. PostreSQL backup files are named:
    (year).(month).(day),(hour).(min).(seconds).dump
	
*******************************
Devportal backup
*******************************

---------------------------------
    * go to /opt/apigee/apigee-drupal/wwwroot directory
	* Make a full backup of all files, directories, and databases. Save the backup in a location outside of the Drupal installation.
	Note that: If you made modifications to files such as .htaccess, robots.txt, or defaults.settings.php (in the sites directory),
	you will have to reapply the changes after the update. You will also need to reapply any customizations made in the sites/all directory.
	Backup procedures:
	------------------
	    * Before you can back up the portal, you must know the name of the portal's database.
		* Use command 'psql -h 10.27.165.137 -d apigee -U drupaladmin -l'
		
		 or  'psql -h 10.71.178.29 -d apigee -U drupaladmin -l'
		
		Password for user drupaladmin:
                                List of databases
   Name    | Owner  | Encoding |   Collate   |    Ctype    |  Access privileges
-----------+--------+----------+-------------+-------------+---------------------
 apigee    | apigee | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =Tc/apigee         +
           |        |          |             |             | apigee=CTc/apigee  +
           |        |          |             |             | postgres=CTc/apigee
 devportal | apigee | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 postgres  | apigee | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0 | apigee | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/apigee          +
           |        |          |             |             | apigee=CTc/apigee
 template1 | apigee | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/apigee          +
           |        |          |             |             | apigee=CTc/apigee
(5 rows)
   * Now start backup:
   *******************
	   * Change to the Drupal directory, /opt/apigee/apigee-drupal by default:
	    cd /opt/apigee/apigee-drupal
	   * Use pg_dump command 
	      pg_dump --dbname=devportal --host=10.27.165.137 --username=drupaladmin --password --format=c > /tmp/portal.bak
	   * Make a backup of your entire Drupal web root directory.
    	   The default webroot location is /opt/apigee/apigee-drupal/wwwroot
		     tar cvf ~/wwwroot.tar wwwroot/*
       * Make a backup of the public files.
     	   By default, these files are located in /opt/apigee/apigee-drupal/wwwroot/sites/default/files
		      cd /opt/apigee/apigee-drupal/wwwroot/sites/default
		      tar cvf ~/files.tar files/*
	   * Make a backup of the private files in /opt/apigee/data/apigee-drupal-devportal/private
	          cd /opt/apigee/apigee-drupal-devportal
	          tar cvf ~/private.tar private/*
			  
    * Put your site on maintenance mode:
	************************************
	     * drush vset --exact maintenance_mode 1
		 * drush cache-clear all
		 
	* Install the desired version of Drupal by using the following command:
	***********************************************************************
	     * drush pm-update drupal-7.67
		 
	* Take your site out of maintenance mode:
	----------------------------------------
	     * drush vset --exact maintenance_mode 0
		 * drush cache-clear all
			  

Restore the portal:
*******************

from backup to an existing---
pg_restore --clean --dbname=devportal --host=localhost  --username=apigee < /tmp/portal.bak


from backup to a new database---
pg_restore --clean --create --dbname=devportal --host=localhost  --username=apigee < /tmp/portal.bak	
	
	
	
	
	
Restore order:
*************** zookeeper-cass-postgresqlDb-postgresserver-qpidDB-Qpidserver-openldap- mgt-MP-MR-edgeUI

/opt/apigee/apigee-service/bin/apigee-service apigee-cassandra restore backup-2019.16.17,14.40.41.tar.gz
similarly for other

After restore check the following:
-----------------------------------

The restore command:

Gets the latest backup file, if a filename was not passed in, or uses the specified backup file.
Checks to see if the directories are empty:
/opt/apigee/data/comp
/opt/apigee/etc/comp.d
If the above directories are not empty, restore stops and ask you to remove them.
Stops the component.
Restore the component from the backup.
Note: You must explicitly restart the component after a restore.

Starting order is important:
*****************************
a) Start the ZooKeeper cluster
b) Start the Cassandra cluster
c) Ensure that OpenLDAP is up and running
d) Start qpid
e) Ensure that the PostgreSQL database is up and running
f) Start Management Server
g) Start Routers and Message Processors
h) Start Qpid Server
i) Start Postgres Server
j) Start Apigee UI

	
	
- name: Clean up Zabbix agent Directories and Files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/zabbix
    - /etc/logrotate.d/zabbix-agent.rpmsave
    - /var/log/zabbix
	
	
- name: Create a directory if it does not exist
  file:
    path: /etc/some_directory
    state: directory
    mode: '0755'
	
- name: Create a symbolic link
  file:
    src: /file/to/link/to
    dest: /path/to/symlink
    owner: foo
    group: foo
    state: link
	
File existence:
***************	
	
- hosts: loc
  tasks:
  - stat:
      path: /home/mdtutorials2/sample_file.txt
    register: result

  - debug:
      msg: "Ansible When File Exists Example."
    when: result.stat.exists